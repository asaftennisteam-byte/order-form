<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>××¢×¨×›×ª ×”×–×× ×ª ×× ×•×ª - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™ ××™×¡×•×¨×“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #f0f4f8; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; }
        .logo-banner { background-color: #1F4E79; padding: 25px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; }
        .logo-main { font-size: 52px; font-weight: bold; color: white; letter-spacing: 8px; margin: 0; }
        .logo-sub { font-size: 18px; color: #8BC34A; letter-spacing: 4px; margin-top: 5px; }
        .header { background-color: #2E75B6; color: white; padding: 15px 25px; margin: 0 0 20px 0; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 22px; line-height: 1.4; }
        .header-left { text-align: left; font-size: 13px; line-height: 1.8; }
        .header-left a { color: white; text-decoration: none; }
        .dashboard { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .section-title { font-weight: bold; color: #1F4E79; margin-bottom: 15px; font-size: 16px; }
        .form-row { display: flex; align-items: center; margin-bottom: 12px; gap: 15px; flex-wrap: wrap; }
        .form-row label { font-weight: bold; min-width: 180px; }
        .form-row input, .form-row select, .form-row textarea { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; background-color: #FFFFD0; width: 350px; -webkit-appearance: none; appearance: none; }
        .form-row select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 10px center; background-size: 16px; padding-left: 35px; }
        .form-row textarea { width: 350px; height: 50px; resize: vertical; }
        .form-row input[type="number"], .form-row input[type="time"] { width: 150px; }
        .buttons { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 14px 30px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
        .btn-add { background-color: #70AD47; color: white; }
        .btn-clear { background-color: #C00000; color: white; }
        .btn-print { background-color: #1F4E79; color: white; }
        .btn-export { background-color: #217346; color: white; }
        .btn-undo { background-color: #FF9800; color: white; }
        #orderContainer { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .order-logo-banner { background-color: #1F4E79; padding: 15px; border-radius: 8px 8px 0 0; text-align: center; }
        .order-logo-main { font-size: 32px; font-weight: bold; color: white; letter-spacing: 5px; margin: 0; }
        .order-logo-sub { font-size: 12px; color: #8BC34A; letter-spacing: 2px; margin-top: 3px; }
        .order-header { background-color: #2E75B6; color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .order-header h2 { margin: 0; font-size: 18px; }
        .order-header-left { font-size: 11px; text-align: left; line-height: 1.6; }
        .order-info { background-color: #D9E2F3; padding: 15px; margin-bottom: 20px; border-radius: 0 0 8px 8px; display: flex; gap: 20px; font-weight: bold; flex-wrap: wrap; }
        .product-section { margin-bottom: 25px; }
        .product-header { background-color: #1F4E79; color: white; padding: 12px 15px; font-weight: bold; font-size: 18px; border-radius: 5px 5px 0 0; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #D9E2F3; padding: 10px; border: 1px solid #888; font-weight: bold; font-size: 14px; }
        td { padding: 10px; border: 1px solid #888; text-align: center; font-size: 14px; }
        td.notes-cell { text-align: right; font-size: 13px; }
        tr:nth-child(even) { background-color: #f5f5f5; }
        .total-row { background-color: #FFF3CD !important; font-weight: bold; }
        .total-row td { border-top: 2px solid #1F4E79; }
        .empty-message { text-align: center; color: #888; padding: 40px; font-size: 18px; }
        @media (max-width: 600px) {
            .logo-main { font-size: 36px; letter-spacing: 4px; }
            .header { flex-direction: column; text-align: center; }
            .form-row { flex-direction: column; align-items: flex-start; }
            .form-row label { min-width: auto; }
            .form-row input, .form-row select, .form-row textarea { width: 100%; }
            .buttons { flex-direction: column; }
            button { width: 100%; }
        }
        @media print {
            .dashboard, .buttons, .logo-banner, .header { display: none !important; }
            #orderContainer { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-banner">
            <div class="logo-main">ISORAD</div>
            <div class="logo-sub">Radiopharmacy</div>
        </div>
        <div class="header">
            <h1>××¢×¨×›×ª ×”×–×× ×ª ×× ×•×ª - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™</h1>
            <div class="header-left">
                ğŸ“ <a href="tel:089434424">08-9434424</a><br>
                âœ‰ï¸ <a href="mailto:radiopharmacy@isorad.co.il">radiopharmacy@isorad.co.il</a>
            </div>
        </div>
        <div class="dashboard">
            <div class="form-section">
                <div class="section-title">×¤×¨×˜×™ ×”×–×× ×”</div>
                <div class="form-row">
                    <label>×©× ×”××›×•×Ÿ:</label>
                    <input type="text" id="institution" placeholder="×”×–×Ÿ ×©× ××›×•×Ÿ">
                </div>
                <div class="form-row">
                    <label>×ª××¨×™×š ×”×–×× ×”:</label>
                    <input type="date" id="orderDate">
                </div>
                <div class="form-row">
                    <label>×©× ××‘×¦×¢ ×”×”×–×× ×”:</label>
                    <input type="text" id="ordererName" placeholder="×”×–×Ÿ ×©×" style="width: 250px;">
                </div>
                <div class="form-row">
                    <label>×¡×•×’ ×”×–×× ×”:</label>
                    <select id="orderType" style="-webkit-appearance: none; appearance: none;">
                        <option value="×”×–×× ×” ××§×•×¨×™×ª">×”×–×× ×” ××§×•×¨×™×ª</option>
                        <option value="×ª×•×¡×¤×ª ×œ×”×–×× ×”">×ª×•×¡×¤×ª ×œ×”×–×× ×”</option>
                        <option value="×‘×™×˜×•×œ ×× ×•×ª">×‘×™×˜×•×œ ×× ×•×ª</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="section-title">×¤×¨×˜×™ ×ª×›×©×™×¨</div>
                <div class="form-row">
                    <label>×‘×—×¨ ×ª×›×©×™×¨:</label>
                    <select id="product" style="-webkit-appearance: none; appearance: none;">
                        <option value="">-- ×‘×—×¨ ×ª×›×©×™×¨ --</option>
                        <option value="MDP">MDP</option>
                        <option value="DMSA">DMSA</option>
                        <option value="S.C">S.C</option>
                        <option value="Sestamibi Stress">Sestamibi Stress</option>
                        <option value="Sestamibi Rest">Sestamibi Rest</option>
                        <option value="Sestamibi Parathyroid">Sestamibi Parathyroid</option>
                        <option value="Ga-67">Ga-67</option>
                        <option value="Tl-201">Tl-201</option>
                        <option value="MAG-3">MAG-3</option>
                        <option value="DTPA">DTPA</option>
                        <option value="Filtered S.C">Filtered S.C</option>
                        <option value="MAA">MAA</option>
                        <option value="FDG">FDG</option>
                        <option value="FDOPA">FDOPA</option>
                        <option value="Ga-68 Dota Tate">Ga-68 Dota Tate</option>
                        <option value="Ga-68 PSMA">Ga-68 PSMA</option>
                        <option value="FPSMA">FPSMA</option>
                        <option value="Tc-99m ×‘××–×¨×§">Tc-99m ×‘××–×¨×§</option>
                        <option value="Tc-99m ×‘×‘×§×‘×•×§×•×Ÿ">Tc-99m ×‘×‘×§×‘×•×§×•×Ÿ</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>×©×¢×ª ×›×™×•×œ ×”×× ×” ×”×¨××©×•× ×”:</label>
                    <input type="time" id="startTime" placeholder="">
                </div>
                <div class="form-row">
                    <label>××¡×¤×¨ ×× ×•×ª:</label>
                    <input type="number" id="numDoses" min="1" max="50" placeholder="">
                </div>
                <div class="form-row">
                    <label>××§×˜×™×‘×™×•×ª (mCi):</label>
                    <input type="number" id="activity" min="0.1" max="100" step="0.1" placeholder="">
                </div>
                <div class="form-row">
                    <label>××¨×•×•×— ×–××Ÿ (×“×§×•×ª):</label>
                    <input type="number" id="interval" min="5" max="120" placeholder="">
                </div>
                <div class="form-row">
                    <label>×”×¢×¨×”:</label>
                    <textarea id="notes" placeholder="×”×¢×¨×” ×œ×× ×•×ª ××œ×• (××•×¤×¦×™×•× ×œ×™)"></textarea>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="btn-add" id="btnAdd">â• ×”×•×¡×£ ×œ×”×–×× ×”</button>
                <button type="button" class="btn-undo" id="btnUndo">â†©ï¸ ×¦×¢×“ ××—×•×¨×”</button>
                <button type="button" class="btn-clear" id="btnClear">ğŸ—‘ï¸ × ×§×” ×”×–×× ×”</button>
                <button type="button" class="btn-print" id="btnPrint">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                <button type="button" class="btn-export" id="btnExport">ğŸ“Š ×™×™×¦× ×œ-Excel</button>
            </div>
        </div>
        <div id="orderContainer">
            <div class="order-logo-banner">
                <div class="order-logo-main">ISORAD</div>
                <div class="order-logo-sub">Radiopharmacy</div>
            </div>
            <div class="order-header">
                <h2>×˜×•×¤×¡ ×”×–×× ×” - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™</h2>
                <div class="order-header-left">ğŸ“ 08-9434424 | âœ‰ï¸ radiopharmacy@isorad.co.il</div>
            </div>
            <div class="order-info">
                <span>××›×•×Ÿ: <span id="displayInstitution">---</span></span>
                <span>×ª××¨×™×š: <span id="displayDate">---</span></span>
                <span>××–××™×Ÿ: <span id="displayOrderer">---</span></span>
                <span>×¡×•×’: <span id="displayOrderType">---</span></span>
                <span>×©×¢×ª ×”×¤×§×”: <span id="displayTimestamp">---</span></span>
            </div>
            <div id="orderContent">
                <div class="empty-message">×œ× × ×•×¡×¤×• ×ª×›×©×™×¨×™× ×œ×”×–×× ×”</div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        var orderData = {};
        var orderHistory = [];
        
        function pad2(n) {
            n = parseInt(n, 10);
            if (n < 10) return '0' + n;
            return '' + n;
        }
        
        function setTomorrowDate() {
            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            var year = tomorrow.getFullYear();
            var month = pad2(tomorrow.getMonth() + 1);
            var day = pad2(tomorrow.getDate());
            document.getElementById('orderDate').value = year + '-' + month + '-' + day;
        }
        
        function getCurrentTime() {
            var now = new Date();
            return pad2(now.getHours()) + ':' + pad2(now.getMinutes());
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '---';
            var parts = dateStr.split('-');
            if (parts.length !== 3) return '---';
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }
        
        function getKeys(obj) {
            var keys = [];
            for (var k in obj) {
                if (obj.hasOwnProperty(k)) {
                    keys.push(k);
                }
            }
            return keys;
        }
        
        function saveHistory() {
            var copy = {};
            for (var k in orderData) {
                if (orderData.hasOwnProperty(k)) {
                    copy[k] = [];
                    for (var i = 0; i < orderData[k].length; i++) {
                        copy[k].push({
                            time: orderData[k][i].time,
                            activity: orderData[k][i].activity,
                            qty: orderData[k][i].qty,
                            notes: orderData[k][i].notes
                        });
                    }
                }
            }
            orderHistory.push(copy);
            if (orderHistory.length > 20) orderHistory.shift();
        }
        
        function undo() {
            if (orderHistory.length === 0) {
                alert('××™×Ÿ ×¤×¢×•×œ×•×ª ×œ×‘×™×˜×•×œ');
                return;
            }
            orderData = orderHistory.pop();
            renderOrder();
        }
        
        function addToOrder() {
            var inst = document.getElementById('institution').value;
            var prod = document.getElementById('product').value;
            var startTime = document.getElementById('startTime').value;
            var numDoses = document.getElementById('numDoses').value;
            var activity = document.getElementById('activity').value;
            var interval = document.getElementById('interval').value;
            var ordererName = document.getElementById('ordererName').value;
            var orderDate = document.getElementById('orderDate').value;
            
            if (!inst) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ××›×•×Ÿ');
                return;
            }
            if (!orderDate) {
                alert('× × ×œ×”×–×™×Ÿ ×ª××¨×™×š ×”×–×× ×”');
                return;
            }
            if (!ordererName) {
                alert('× × ×œ×”×–×™×Ÿ ×©× ××‘×¦×¢ ×”×”×–×× ×”');
                return;
            }
            if (!prod) {
                alert('× × ×œ×‘×—×•×¨ ×ª×›×©×™×¨');
                return;
            }
            if (!startTime) {
                alert('× × ×œ×”×–×™×Ÿ ×©×¢×ª ×›×™×•×œ');
                return;
            }
            if (!numDoses || numDoses < 1) {
                alert('× × ×œ×”×–×™×Ÿ ××¡×¤×¨ ×× ×•×ª');
                return;
            }
            if (!activity || activity <= 0) {
                alert('× × ×œ×”×–×™×Ÿ ××§×˜×™×‘×™×•×ª');
                return;
            }
            if (!interval || interval < 1) {
                alert('× × ×œ×”×–×™×Ÿ ××¨×•×•×— ×–××Ÿ');
                return;
            }
            
            var dt = orderDate;
            var nm = ordererName;
            var orderType = document.getElementById('orderType').value;
            var notes = document.getElementById('notes').value;
            var num = parseInt(numDoses, 10);
            var act = parseFloat(activity);
            var intv = parseInt(interval, 10);
            
            // Check Sestamibi Stress/Rest balance
            if (prod === 'Sestamibi Stress' || prod === 'Sestamibi Rest') {
                var other = prod === 'Sestamibi Stress' ? 'Sestamibi Rest' : 'Sestamibi Stress';
                var currentCount = orderData[prod] ? orderData[prod].length : 0;
                var otherCount = orderData[other] ? orderData[other].length : 0;
                var newTotal = currentCount + num;
                if (otherCount > 0 && newTotal !== otherCount) {
                    alert('×©×’×™××”: ×›××•×ª ' + prod + ' (' + newTotal + ') ×œ× ×ª×•×××ª ×œ×›××•×ª ' + other + ' (' + otherCount + ').\n\n×”×›××•×™×•×ª ×—×™×™×‘×•×ª ×œ×”×™×•×ª ×©×•×•×ª.\n×× ×”×›××•×™×•×ª ×œ× ×©×•×•×ª, ×™×© ×œ×”×©×ª××© ×‘-Sestamibi Parathyroid.');
                    return;
                }
            }
            
            saveHistory();
            
            // Lock order type after first item
            document.getElementById('orderType').disabled = true;
            
            document.getElementById('displayInstitution').innerHTML = inst;
            document.getElementById('displayDate').innerHTML = formatDate(dt);
            document.getElementById('displayOrderer').innerHTML = nm || '---';
            document.getElementById('displayOrderType').innerHTML = orderType;
            
            var timeParts = startTime.split(':');
            var hours = parseInt(timeParts[0], 10) || 8;
            var minutes = parseInt(timeParts[1], 10) || 0;
            var currentMinutes = hours * 60 + minutes;
            
            if (!orderData[prod]) {
                orderData[prod] = [];
            }
            
            for (var i = 0; i < num; i++) {
                var h = Math.floor(currentMinutes / 60) % 24;
                var m = currentMinutes % 60;
                var timeStr = pad2(h) + ':' + pad2(m);
                
                orderData[prod].push({
                    time: timeStr,
                    activity: act,
                    qty: 1,
                    notes: notes || ''
                });
                currentMinutes = currentMinutes + intv;
            }
            
            renderOrder();
            document.getElementById('product').value = '';
            document.getElementById('notes').value = '';
        }
        
        function renderOrder() {
            var container = document.getElementById('orderContent');
            var products = getKeys(orderData);
            
            if (products.length === 0) {
                container.innerHTML = '<div class="empty-message">×œ× × ×•×¡×¤×• ×ª×›×©×™×¨×™× ×œ×”×–×× ×”</div>';
                return;
            }
            
            var html = '';
            for (var p = 0; p < products.length; p++) {
                var product = products[p];
                var doses = orderData[product];
                var totalQty = doses.length;
                
                html += '<div class="product-section">';
                html += '<div class="product-header">' + product + '</div>';
                html += '<table><thead><tr>';
                html += '<th style="width:15%">×©×¢×ª ×›×™×•×œ</th>';
                html += '<th style="width:15%">××§×˜×™×‘×™×•×ª (mCi)</th>';
                html += '<th style="width:10%">×›××•×ª</th>';
                html += '<th style="width:60%">×”×¢×¨×•×ª</th>';
                html += '</tr></thead><tbody>';
                
                for (var d = 0; d < doses.length; d++) {
                    var dose = doses[d];
                    html += '<tr>';
                    html += '<td>' + dose.time + '</td>';
                    html += '<td>' + dose.activity + '</td>';
                    html += '<td>' + dose.qty + '</td>';
                    html += '<td class="notes-cell">' + dose.notes + '</td>';
                    html += '</tr>';
                }
                
                html += '<tr class="total-row">';
                html += '<td colspan="2" style="text-align: right; font-weight: bold;">×¡×”×´×› ×× ×•×ª:</td>';
                html += '<td style="font-weight: bold;">' + totalQty + '</td>';
                html += '<td></td>';
                html += '</tr>';
                html += '</tbody></table></div>';
            }
            
            container.innerHTML = html;
        }
        
        function clearOrder() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×”×”×–×× ×”?')) {
                orderData = {};
                orderHistory = [];
                document.getElementById('orderType').disabled = false;
                document.getElementById('displayInstitution').innerHTML = '---';
                document.getElementById('displayDate').innerHTML = '---';
                document.getElementById('displayOrderer').innerHTML = '---';
                document.getElementById('displayOrderType').innerHTML = '---';
                document.getElementById('displayTimestamp').innerHTML = '---';
                renderOrder();
            }
        }
        
        function printOrder() {
            var products = getKeys(orderData);
            if (products.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×“×¤×¡×”');
                return;
            }
            document.getElementById('displayTimestamp').innerHTML = getCurrentTime();
            setTimeout(function() { window.print(); }, 100);
        }
        
        function exportToExcel() {
            var prods = getKeys(orderData);
            if (prods.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }
            
            var inst = document.getElementById('displayInstitution').innerHTML;
            var dt = document.getElementById('displayDate').innerHTML;
            var ord = document.getElementById('displayOrderer').innerHTML;
            var orderType = document.getElementById('displayOrderType').innerHTML;
            var ts = getCurrentTime();
            document.getElementById('displayTimestamp').innerHTML = ts;
            
            var wb = new ExcelJS.Workbook();
            var ws = wb.addWorksheet('×”×–×× ×”', { views: [{ rightToLeft: true }] });
            
            ws.columns = [
                { width: 18 },
                { width: 20 },
                { width: 12 },
                { width: 50 }
            ];
            
            ws.mergeCells('A1:D1');
            var title = ws.getCell('A1');
            title.value = 'ISORAD - Radiopharmacy';
            title.font = { bold: true, size: 20, color: { argb: 'FFFFFFFF' } };
            title.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E79' } };
            title.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(1).height = 32;
            
            ws.mergeCells('A2:D2');
            var subtitle = ws.getCell('A2');
            subtitle.value = orderType + ' - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™';
            subtitle.font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            
            // Set color based on order type
            var subtitleColor = 'FF2E75B6'; // Default blue for ×”×–×× ×” ××§×•×¨×™×ª
            if (orderType === '×ª×•×¡×¤×ª ×œ×”×–×× ×”') {
                subtitleColor = 'FF28A745'; // Green
            } else if (orderType === '×‘×™×˜×•×œ ×× ×•×ª') {
                subtitleColor = 'FFDC3545'; // Red
            }
            subtitle.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: subtitleColor } };
            subtitle.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(2).height = 24;
            
            ws.mergeCells('A3:D3');
            var info = ws.getCell('A3');
            info.value = '××›×•×Ÿ: ' + inst;
            info.font = { bold: true, size: 11 };
            info.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
            info.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(3).height = 22;
            
            ws.mergeCells('A4:D4');
            var info2 = ws.getCell('A4');
            info2.value = '×ª××¨×™×š: ' + dt + '  |  ××–××™×Ÿ: ' + ord + '  |  ×©×¢×ª ×”×¤×§×”: ' + ts;
            info2.font = { bold: true, size: 11 };
            info2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
            info2.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(4).height = 22;
            
            ws.mergeCells('A5:D5');
            var contact = ws.getCell('A5');
            contact.value = '×˜×œ×¤×•×Ÿ: 08-9434424  |  ××™×™×œ: radiopharmacy@isorad.co.il';
            contact.font = { size: 10 };
            contact.alignment = { horizontal: 'center' };
            
            var row = 7;
            
            for (var p = 0; p < prods.length; p++) {
                var product = prods[p];
                var doses = orderData[product];
                var totalQty = doses.length;
                
                ws.mergeCells('A' + row + ':D' + row);
                var prodCell = ws.getCell('A' + row);
                prodCell.value = product;
                prodCell.font = { bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                prodCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E79' } };
                prodCell.alignment = { horizontal: 'center', vertical: 'middle' };
                ws.getRow(row).height = 24;
                row++;
                
                var headers = ['×©×¢×ª ×›×™×•×œ', '××§×˜×™×‘×™×•×ª (mCi)', '×›××•×ª', '×”×¢×¨×•×ª'];
                for (var h = 0; h < headers.length; h++) {
                    var hCell = ws.getCell(row, h + 1);
                    hCell.value = headers[h];
                    hCell.font = { bold: true };
                    hCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
                    hCell.alignment = { horizontal: 'center' };
                    hCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                }
                row++;
                
                for (var d = 0; d < doses.length; d++) {
                    var dose = doses[d];
                    ws.getCell(row, 1).value = dose.time;
                    ws.getCell(row, 2).value = dose.activity;
                    ws.getCell(row, 3).value = dose.qty;
                    ws.getCell(row, 4).value = dose.notes || '';
                    
                    for (var x = 1; x <= 4; x++) {
                        var dCell = ws.getCell(row, x);
                        dCell.alignment = { horizontal: x === 4 ? 'right' : 'center', wrapText: true };
                        dCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (d % 2 === 1) {
                            dCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5F5' } };
                        }
                    }
                    row++;
                }
                
                ws.mergeCells('A' + row + ':B' + row);
                var totalLabelCell = ws.getCell('A' + row);
                totalLabelCell.value = '×¡×”×´×› ×× ×•×ª:';
                totalLabelCell.font = { bold: true };
                totalLabelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                totalLabelCell.alignment = { horizontal: 'right' };
                totalLabelCell.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                
                var totalQtyCell = ws.getCell(row, 3);
                totalQtyCell.value = totalQty;
                totalQtyCell.font = { bold: true };
                totalQtyCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                totalQtyCell.alignment = { horizontal: 'center' };
                totalQtyCell.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                
                var emptyCell = ws.getCell(row, 4);
                emptyCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                emptyCell.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                
                row += 2;
            }
            
            wb.xlsx.writeBuffer().then(function(buffer) {
                var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                var link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                var safeInst = (inst || 'order').substring(0, 30);
                var safeDate = (dt || '').replace(/\//g, '-');
                link.download = orderType + '_' + safeInst + '_' + safeDate + '.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }
        
        // Initialize
        setTomorrowDate();
        
        // Event handlers
        document.getElementById('btnAdd').onclick = addToOrder;
        document.getElementById('btnUndo').onclick = undo;
        document.getElementById('btnClear').onclick = clearOrder;
        document.getElementById('btnPrint').onclick = printOrder;
        document.getElementById('btnExport').onclick = exportToExcel;
    })();
    </script>
</body>
</html>
