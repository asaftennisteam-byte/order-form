<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>××¢×¨×›×ª ×”×–×× ×ª ×× ×•×ª - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™ ××™×¡×•×¨×“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background-color: #f0f4f8; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; }
        .logo-banner { background-color: #1F4E79; padding: 25px; margin: 0 0 20px 0; border-radius: 8px; text-align: center; }
        .logo-main { font-size: 52px; font-weight: bold; color: white; letter-spacing: 8px; margin: 0; }
        .logo-sub { font-size: 18px; color: #8BC34A; letter-spacing: 4px; margin-top: 5px; }
        .header { background-color: #2E75B6; color: white; padding: 15px 25px; margin: 0 0 20px 0; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .header h1 { margin: 0; font-size: 22px; line-height: 1.4; }
        .header-left { text-align: left; font-size: 13px; line-height: 1.8; }
        .header-left a { color: white; text-decoration: none; }
        .dashboard { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .section-title { font-weight: bold; color: #1F4E79; margin-bottom: 15px; font-size: 16px; }
        .form-row { display: flex; align-items: center; margin-bottom: 12px; gap: 15px; flex-wrap: wrap; }
        .form-row label { font-weight: bold; min-width: 180px; }
        .form-row input, .form-row select, .form-row textarea { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; background-color: #FFFFD0; width: 350px; }
        .form-row select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 10px center; background-size: 16px; padding-left: 35px; }
        .form-row textarea { width: 350px; height: 50px; resize: vertical; }
        .form-row input[type="number"], .form-row input[type="time"] { width: 150px; }
        .buttons { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        button { padding: 14px 30px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; }
        .btn-add { background-color: #70AD47; color: white; }
        .btn-clear { background-color: #C00000; color: white; }
        .btn-print { background-color: #1F4E79; color: white; }
        .btn-export { background-color: #217346; color: white; }
        .btn-undo { background-color: #FF9800; color: white; }
        .btn-email { background-color: #D44638; color: white; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
        .modal-title { font-size: 20px; font-weight: bold; color: #1F4E79; margin-bottom: 20px; }
        .modal-buttons { display: flex; flex-direction: column; gap: 12px; }
        .modal-btn { padding: 15px 20px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        .btn-gmail { background-color: #EA4335; color: white; }
        .btn-outlook { background-color: #0078D4; color: white; }
        .btn-cancel { background-color: #6c757d; color: white; margin-top: 10px; }
        #orderContainer { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .order-logo-banner { background-color: #1F4E79; padding: 15px; border-radius: 8px 8px 0 0; text-align: center; }
        .order-logo-main { font-size: 32px; font-weight: bold; color: white; letter-spacing: 5px; margin: 0; }
        .order-logo-sub { font-size: 12px; color: #8BC34A; letter-spacing: 2px; margin-top: 3px; }
        .order-header { background-color: #2E75B6; color: white; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
        .order-header h2 { margin: 0; font-size: 18px; }
        .order-header-left { font-size: 11px; text-align: left; line-height: 1.6; }
        .order-info { background-color: #D9E2F3; padding: 15px; margin-bottom: 20px; border-radius: 0 0 8px 8px; display: flex; gap: 20px; font-weight: bold; flex-wrap: wrap; }
        .product-section { margin-bottom: 25px; }
        .product-header { background-color: #1F4E79; color: white; padding: 12px 15px; font-weight: bold; font-size: 18px; border-radius: 5px 5px 0 0; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: #D9E2F3; padding: 10px; border: 1px solid #888; font-weight: bold; font-size: 14px; }
        td { padding: 10px; border: 1px solid #888; text-align: center; font-size: 14px; }
        td.notes-cell { text-align: right; font-size: 13px; }
        tr:nth-child(even) { background-color: #f5f5f5; }
        .total-row { background-color: #FFF3CD !important; font-weight: bold; }
        .total-row td { border-top: 2px solid #1F4E79; }
        .empty-message { text-align: center; color: #888; padding: 40px; font-size: 18px; }
        @media (max-width: 600px) {
            .logo-main { font-size: 36px; letter-spacing: 4px; }
            .header { flex-direction: column; text-align: center; }
            .form-row { flex-direction: column; align-items: flex-start; }
            .form-row label { min-width: auto; }
            .form-row input, .form-row select, .form-row textarea { width: 100%; }
            .buttons { flex-direction: column; }
            button { width: 100%; }
        }
        @media print {
            .dashboard, .buttons, .logo-banner, .header, .modal-overlay { display: none !important; }
            #orderContainer { box-shadow: none; padding: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-banner">
            <div class="logo-main">ISORAD</div>
            <div class="logo-sub">Radiopharmacy</div>
        </div>
        <div class="header">
            <h1>××¢×¨×›×ª ×”×–×× ×ª ×× ×•×ª - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™</h1>
            <div class="header-left">
                ğŸ“ <a href="tel:089434424">08-9434424</a><br>
                âœ‰ï¸ <a href="mailto:radiopharmacy@isorad.co.il">radiopharmacy@isorad.co.il</a>
            </div>
        </div>
        <div class="dashboard">
            <div class="form-section">
                <div class="section-title">×¤×¨×˜×™ ×”×–×× ×”</div>
                <div class="form-row">
                    <label>×©× ×”××•×¡×“:</label>
                    <select id="institution">
                        <option value="">-- ×‘×—×¨ ××•×¡×“ --</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×”×“×¡×” ×¢×™×Ÿ-×›×¨×">××¨×›×– ×¨×¤×•××™ ×”×“×¡×” ×¢×™×Ÿ-×›×¨×</option>
                        <option value="×.×.×¨ ×™×¨×•×©×œ×™×">×.×.×¨ ×™×¨×•×©×œ×™×</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×©×¢×¨×™ ×¦×“×§">××¨×›×– ×¨×¤×•××™ ×©×¢×¨×™ ×¦×“×§</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ××¡×£ ×”×¨×•×¤×">××¨×›×– ×¨×¤×•××™ ××¡×£ ×”×¨×•×¤×</option>
                        <option value="×”××¨×›×– ×¨×¤×•××™ ×©×™×‘×">×”××¨×›×– ×¨×¤×•××™ ×©×™×‘×</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×•×•×œ×¤×¡×•×Ÿ">××¨×›×– ×¨×¤×•××™ ×•×•×œ×¤×¡×•×Ÿ</option>
                        <option value="××¨×›×– ×©× ×™×™×“×¨ ×œ×¨×¤×•××ª ×™×œ×“×™×">××¨×›×– ×©× ×™×™×“×¨ ×œ×¨×¤×•××ª ×™×œ×“×™×</option>
                        <option value="×‘×™×´×— ×‘×™×œ×™× ×¡×•×Ÿ">×‘×™×´×— ×‘×™×œ×™× ×¡×•×Ÿ</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ××™×›×™×œ×•×‘">××¨×›×– ×¨×¤×•××™ ××™×›×™×œ×•×‘</option>
                        <option value="××¡×•×ª× ×¨××©×œ×´×¦">××¡×•×ª× ×¨××©×œ×´×¦</option>
                        <option value="××¡×•×ª× ×¨××ª ×”×—×™×™×œ">××¡×•×ª× ×¨××ª ×”×—×™×™×œ</option>
                        <option value="××¡×•×ª× ××©×“×•×“">××¡×•×ª× ××©×“×•×“</option>
                        <option value="××¡×•×ª× ×—×™×¤×”">××¡×•×ª× ×—×™×¤×”</option>
                        <option value="××¡×•×ª× ×‘××¨ ×©×‘×¢">××¡×•×ª× ×‘××¨ ×©×‘×¢</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×¨××‘×´×">××¨×›×– ×¨×¤×•××™ ×¨××‘×´×</option>
                        <option value="×”××¨×›×– ×”×¨×¤×•××™ ×–×™×•">×”××¨×›×– ×”×¨×¤×•××™ ×–×™×•</option>
                        <option value="×”××¨×›×– ×”×¨×¤×•××™ ×”×œ×œ ×™×¤×”">×”××¨×›×– ×”×¨×¤×•××™ ×”×œ×œ ×™×¤×”</option>
                        <option value="×‘×™×ª ×—×•×œ×™× × ×”×¨×™×”">×‘×™×ª ×—×•×œ×™× × ×”×¨×™×”</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×›×¨××œ">××¨×›×– ×¨×¤×•××™ ×›×¨××œ</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×××™×¨">××¨×›×– ×¨×¤×•××™ ×××™×¨</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×”×¢××§">××¨×›×– ×¨×¤×•××™ ×”×¢××§</option>
                        <option value="×‘×™×ª ×—×•×œ×™× ×‘×¨×–×™×œ×™">×‘×™×ª ×—×•×œ×™× ×‘×¨×–×™×œ×™</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×§×¤×œ×Ÿ">××¨×›×– ×¨×¤×•××™ ×§×¤×œ×Ÿ</option>
                        <option value="××¨×›×– ×¨×¤×•××™ ×¡×•×¨×•×§×”">××¨×›×– ×¨×¤×•××™ ×¡×•×¨×•×§×”</option>
                        <option value="×.×.×¨ ×‘××¨ ×©×‘×¢">×.×.×¨ ×‘××¨ ×©×‘×¢</option>
                        <option value="×.×.×¨ × ×¦×¨×ª">×.×.×¨ × ×¦×¨×ª</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>×ª××¨×™×š ×”×–×× ×”:</label>
                    <input type="date" id="orderDate">
                </div>
                <div class="form-row">
                    <label>×©× ××‘×¦×¢ ×”×”×–×× ×”:</label>
                    <input type="text" id="ordererName" placeholder="×”×–×Ÿ ×©×" style="width: 250px;">
                </div>
            </div>
            <div class="form-section">
                <div class="section-title">×¤×¨×˜×™ ×ª×›×©×™×¨</div>
                <div class="form-row">
                    <label>×‘×—×¨ ×ª×›×©×™×¨:</label>
                    <select id="product">
                        <option value="">-- ×‘×—×¨ ×ª×›×©×™×¨ --</option>
                        <option value="MDP">MDP</option>
                        <option value="DMSA">DMSA</option>
                        <option value="S.C">S.C</option>
                        <option value="Sestamibi Stress">Sestamibi Stress</option>
                        <option value="Sestamibi Rest">Sestamibi Rest</option>
                        <option value="Sestamibi Parathyroid">Sestamibi Parathyroid</option>
                        <option value="Ga-67">Ga-67</option>
                        <option value="Tl-201">Tl-201</option>
                        <option value="MAG-3">MAG-3</option>
                        <option value="DTPA">DTPA</option>
                        <option value="Filter S.C">Filter S.C</option>
                        <option value="MAA">MAA</option>
                        <option value="FDG">FDG</option>
                        <option value="Ga-68 Dota Tate">Ga-68 Dota Tate</option>
                        <option value="Ga-68 PSMA">Ga-68 PSMA</option>
                        <option value="FPSMA">FPSMA</option>
                        <option value="Tc-99 ×‘××–×¨×§">Tc-99 ×‘××–×¨×§</option>
                        <option value="Tc-99 ×‘×‘×§×‘×•×§×•×Ÿ">Tc-99 ×‘×‘×§×‘×•×§×•×Ÿ</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>×©×¢×ª ×›×™×•×œ ×”×× ×” ×”×¨××©×•× ×”:</label>
                    <input type="time" id="startTime" value="08:00">
                </div>
                <div class="form-row">
                    <label>××¡×¤×¨ ×× ×•×ª:</label>
                    <input type="number" id="numDoses" min="1" max="50" value="5">
                </div>
                <div class="form-row">
                    <label>××§×˜×™×‘×™×•×ª (mCi):</label>
                    <input type="number" id="activity" min="0.1" max="100" step="0.1" value="25">
                </div>
                <div class="form-row">
                    <label>××¨×•×•×— ×–××Ÿ (×“×§×•×ª):</label>
                    <input type="number" id="interval" min="5" max="120" value="30">
                </div>
                <div class="form-row">
                    <label>×”×¢×¨×”:</label>
                    <textarea id="notes" placeholder="×”×¢×¨×” ×œ×× ×•×ª ××œ×• (××•×¤×¦×™×•× ×œ×™)"></textarea>
                </div>
            </div>
            <div class="buttons">
                <button type="button" class="btn-add" id="btnAdd">â• ×”×•×¡×£ ×œ×”×–×× ×”</button>
                <button type="button" class="btn-undo" id="btnUndo">â†©ï¸ ×¦×¢×“ ××—×•×¨×”</button>
                <button type="button" class="btn-clear" id="btnClear">ğŸ—‘ï¸ × ×§×” ×”×–×× ×”</button>
                <button type="button" class="btn-print" id="btnPrint">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                <button type="button" class="btn-export" id="btnExport">ğŸ“Š ×™×™×¦× ×œ-Excel</button>
                <button type="button" class="btn-email" id="btnEmail">ğŸ“§ ×©×œ×— ×‘××™×™×œ</button>
            </div>
        </div>
        <div id="orderContainer">
            <div class="order-logo-banner">
                <div class="order-logo-main">ISORAD</div>
                <div class="order-logo-sub">Radiopharmacy</div>
            </div>
            <div class="order-header">
                <h2>×˜×•×¤×¡ ×”×–×× ×” - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™</h2>
                <div class="order-header-left">ğŸ“ 08-9434424 | âœ‰ï¸ radiopharmacy@isorad.co.il</div>
            </div>
            <div class="order-info">
                <span>××•×¡×“: <span id="displayInstitution">---</span></span>
                <span>×ª××¨×™×š: <span id="displayDate">---</span></span>
                <span>××–××™×Ÿ: <span id="displayOrderer">---</span></span>
                <span>×©×¢×ª ×”×¤×§×”: <span id="displayTimestamp">---</span></span>
            </div>
            <div id="orderContent">
                <div class="empty-message">×œ× × ×•×¡×¤×• ×ª×›×©×™×¨×™× ×œ×”×–×× ×”</div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="emailModal">
        <div class="modal-content">
            <div class="modal-title">×‘×—×¨ ××¤×œ×™×§×¦×™×™×ª ××™×™×œ</div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-gmail" id="btnGmail">ğŸ“§ Gmail</button>
                <button type="button" class="modal-btn btn-outlook" id="btnOutlook">ğŸ“§ Outlook</button>
                <button type="button" class="modal-btn btn-cancel" id="btnCancel">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>
    <script>
    (function() {
        var orderData = {};
        var orderHistory = [];
        
        function saveHistory() {
            var copy = {};
            for (var k in orderData) {
                if (orderData.hasOwnProperty(k)) {
                    copy[k] = [];
                    for (var i = 0; i < orderData[k].length; i++) {
                        copy[k].push({ time: orderData[k][i].time, activity: orderData[k][i].activity, qty: orderData[k][i].qty, notes: orderData[k][i].notes });
                    }
                }
            }
            orderHistory.push(copy);
            if (orderHistory.length > 20) orderHistory.shift();
        }
        
        function undo() {
            if (orderHistory.length === 0) { alert('××™×Ÿ ×¤×¢×•×œ×•×ª ×œ×‘×™×˜×•×œ'); return; }
            orderData = orderHistory.pop();
            renderOrder();
        }
        
        function pad2(n) { n = parseInt(n, 10); return (n < 10 ? '0' : '') + n; }
        function setTomorrowDate() {
            var t = new Date(); t.setDate(t.getDate() + 1);
            document.getElementById('orderDate').value = t.getFullYear() + '-' + pad2(t.getMonth() + 1) + '-' + pad2(t.getDate());
        }
        function getCurrentTime() { var n = new Date(); return pad2(n.getHours()) + ':' + pad2(n.getMinutes()); }
        function formatDate(s) { if (!s) return '---'; var p = s.split('-'); return p[2] + '/' + p[1] + '/' + p[0]; }
        function getKeys(o) { var k = []; for (var x in o) { if (o.hasOwnProperty(x)) k.push(x); } return k; }
        
        function addToOrder() {
            var inst = document.getElementById('institution').value;
            var prod = document.getElementById('product').value;
            if (!prod) { alert('× × ×œ×‘×—×•×¨ ×ª×›×©×™×¨'); return; }
            if (!inst) { alert('× × ×œ×‘×—×•×¨ ××•×¡×“'); return; }
            var dt = document.getElementById('orderDate').value;
            var nm = document.getElementById('ordererName').value;
            var tm = document.getElementById('startTime').value || '08:00';
            var num = parseInt(document.getElementById('numDoses').value, 10) || 5;
            var act = parseFloat(document.getElementById('activity').value) || 25;
            var intv = parseInt(document.getElementById('interval').value, 10) || 30;
            var notes = document.getElementById('notes').value;
            
            // Check Sestamibi Stress/Rest balance
            if (prod === 'Sestamibi Stress' || prod === 'Sestamibi Rest') {
                var other = prod === 'Sestamibi Stress' ? 'Sestamibi Rest' : 'Sestamibi Stress';
                var currentCount = orderData[prod] ? orderData[prod].length : 0;
                var otherCount = orderData[other] ? orderData[other].length : 0;
                var newTotal = currentCount + num;
                if (otherCount > 0 && newTotal !== otherCount) {
                    var msg = '×©×’×™××”: ×›××•×ª ' + prod + ' (' + newTotal + ') ×œ× ×ª×•×××ª ×œ×›××•×ª ' + other + ' (' + otherCount + ').\n\n';
                    msg += '×”×›××•×™×•×ª ×—×™×™×‘×•×ª ×œ×”×™×•×ª ×©×•×•×ª.\n';
                    msg += '×× ×”×›××•×™×•×ª ×œ× ×©×•×•×ª, ×™×© ×œ×”×©×ª××© ×‘-Sestamibi Parathyroid.';
                    alert(msg);
                    return;
                }
            }
            
            saveHistory();
            document.getElementById('displayInstitution').innerHTML = inst;
            document.getElementById('displayDate').innerHTML = formatDate(dt);
            document.getElementById('displayOrderer').innerHTML = nm || '---';
            var parts = tm.split(':');
            var mins = (parseInt(parts[0],10)||8)*60 + (parseInt(parts[1],10)||0);
            if (!orderData[prod]) orderData[prod] = [];
            for (var i = 0; i < num; i++) {
                var h = Math.floor(mins/60)%24, m = mins%60;
                orderData[prod].push({ time: pad2(h)+':'+pad2(m), activity: act, qty: 1, notes: notes||'' });
                mins += intv;
            }
            renderOrder();
            document.getElementById('product').value = '';
            document.getElementById('notes').value = '';
        }
        
        function renderOrder() {
            var c = document.getElementById('orderContent');
            var prods = getKeys(orderData);
            if (prods.length === 0) { c.innerHTML = '<div class="empty-message">×œ× × ×•×¡×¤×• ×ª×›×©×™×¨×™× ×œ×”×–×× ×”</div>'; return; }
            var html = '';
            for (var p = 0; p < prods.length; p++) {
                var prod = prods[p], doses = orderData[prod], total = doses.length;
                html += '<div class="product-section"><div class="product-header">' + prod + '</div>';
                html += '<table><thead><tr><th style="width:15%">×©×¢×ª ×›×™×•×œ</th><th style="width:15%">××§×˜×™×‘×™×•×ª (mCi)</th><th style="width:10%">×›××•×ª</th><th style="width:60%">×”×¢×¨×•×ª</th></tr></thead><tbody>';
                for (var d = 0; d < doses.length; d++) {
                    var dose = doses[d];
                    html += '<tr><td>' + dose.time + '</td><td>' + dose.activity + '</td><td>' + dose.qty + '</td><td class="notes-cell">' + dose.notes + '</td></tr>';
                }
                html += '<tr class="total-row"><td colspan="2" style="text-align:right;font-weight:bold;">×¡×”×´×› ×× ×•×ª:</td><td style="font-weight:bold;">' + total + '</td><td></td></tr>';
                html += '</tbody></table></div>';
            }
            c.innerHTML = html;
        }
        
        function clearOrder() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×—?')) {
                orderData = {};
                document.getElementById('displayInstitution').innerHTML = '---';
                document.getElementById('displayDate').innerHTML = '---';
                document.getElementById('displayOrderer').innerHTML = '---';
                document.getElementById('displayTimestamp').innerHTML = '---';
                renderOrder();
            }
        }
        
        function printOrder() {
            if (getKeys(orderData).length === 0) { alert('××™×Ÿ × ×ª×•× ×™× ×œ×”×“×¤×¡×”'); return; }
            document.getElementById('displayTimestamp').innerHTML = getCurrentTime();
            setTimeout(function() { window.print(); }, 100);
        }
        
        function getEmailData() {
            var inst = document.getElementById('displayInstitution').innerHTML;
            var dt = document.getElementById('displayDate').innerHTML;
            var ord = document.getElementById('displayOrderer').innerHTML;
            var subj = '×”×–×× ×ª ×× ×•×ª - ' + inst + ' - ' + dt;
            var body = '×©×œ×•× ×¨×‘,\n\n××¦×•×¨×£ ×§×•×‘×¥ ×”×–×× ×ª ×× ×•×ª.\n\n* × × ×œ×¦×¨×£ ××ª ×§×•×‘×¥ ×”××§×¡×œ *\n\n×‘×‘×¨×›×”,\n' + ord;
            return { subject: subj, body: body };
        }
        
        function showEmailModal() {
            if (getKeys(orderData).length === 0) { alert('××™×Ÿ × ×ª×•× ×™× ×œ×©×œ×™×—×”'); return; }
            document.getElementById('emailModal').classList.add('show');
        }
        function hideEmailModal() { document.getElementById('emailModal').classList.remove('show'); }
        
        function sendViaGmail() {
            var d = getEmailData();
            window.open('https://mail.google.com/mail/?view=cm&fs=1&to=radiopharmacy@isorad.co.il&su=' + encodeURIComponent(d.subject) + '&body=' + encodeURIComponent(d.body), '_blank');
            hideEmailModal();
        }
        function sendViaOutlook() {
            var d = getEmailData();
            window.open('https://outlook.live.com/mail/0/deeplink/compose?to=radiopharmacy@isorad.co.il&subject=' + encodeURIComponent(d.subject) + '&body=' + encodeURIComponent(d.body), '_blank');
            hideEmailModal();
        }
        
        function exportToExcel() {
            var prods = getKeys(orderData);
            if (prods.length === 0) { alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×'); return; }
            var inst = document.getElementById('displayInstitution').innerHTML;
            var dt = document.getElementById('displayDate').innerHTML;
            var ord = document.getElementById('displayOrderer').innerHTML;
            var ts = getCurrentTime();
            document.getElementById('displayTimestamp').innerHTML = ts;
            var wb = new ExcelJS.Workbook();
            var ws = wb.addWorksheet('×”×–×× ×”', { views: [{ rightToLeft: true }] });
            ws.columns = [{ width: 18 }, { width: 20 }, { width: 12 }, { width: 50 }];
            ws.mergeCells('A1:D1');
            var t = ws.getCell('A1'); t.value = 'ISORAD - Radiopharmacy';
            t.font = { bold: true, size: 20, color: { argb: 'FFFFFFFF' } };
            t.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E79' } };
            t.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(1).height = 32;
            ws.mergeCells('A2:D2');
            var s = ws.getCell('A2'); s.value = '×˜×•×¤×¡ ×”×–×× ×” - ×‘×™×ª ××¨×§×—×ª ×’×¨×¢×™× ×™';
            s.font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
            s.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2E75B6' } };
            s.alignment = { horizontal: 'center', vertical: 'middle' };
            ws.getRow(2).height = 24;
            ws.mergeCells('A3:D3');
            var i3 = ws.getCell('A3'); i3.value = '××•×¡×“: ' + inst;
            i3.font = { bold: true, size: 11 }; i3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
            i3.alignment = { horizontal: 'center', vertical: 'middle' }; ws.getRow(3).height = 22;
            ws.mergeCells('A4:D4');
            var i4 = ws.getCell('A4'); i4.value = '×ª××¨×™×š: ' + dt + '  |  ××–××™×Ÿ: ' + ord + '  |  ×©×¢×ª ×”×¤×§×”: ' + ts;
            i4.font = { bold: true, size: 11 }; i4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
            i4.alignment = { horizontal: 'center', vertical: 'middle' }; ws.getRow(4).height = 22;
            ws.mergeCells('A5:D5');
            var c5 = ws.getCell('A5'); c5.value = '×˜×œ×¤×•×Ÿ: 08-9434424  |  ××™×™×œ: radiopharmacy@isorad.co.il';
            c5.font = { size: 10 }; c5.alignment = { horizontal: 'center' };
            var row = 7;
            for (var p = 0; p < prods.length; p++) {
                var prod = prods[p], doses = orderData[prod], totalQty = doses.length;
                ws.mergeCells('A' + row + ':D' + row);
                var pc = ws.getCell('A' + row); pc.value = prod;
                pc.font = { bold: true, size: 13, color: { argb: 'FFFFFFFF' } };
                pc.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1F4E79' } };
                pc.alignment = { horizontal: 'center', vertical: 'middle' };
                ws.getRow(row).height = 24; row++;
                var hdrs = ['×©×¢×ª ×›×™×•×œ', '××§×˜×™×‘×™×•×ª (mCi)', '×›××•×ª', '×”×¢×¨×•×ª'];
                for (var h = 0; h < hdrs.length; h++) {
                    var hc = ws.getCell(row, h + 1); hc.value = hdrs[h]; hc.font = { bold: true };
                    hc.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9E2F3' } };
                    hc.alignment = { horizontal: 'center' };
                    hc.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                }
                row++;
                for (var d = 0; d < doses.length; d++) {
                    var dose = doses[d];
                    ws.getCell(row, 1).value = dose.time;
                    ws.getCell(row, 2).value = dose.activity;
                    ws.getCell(row, 3).value = dose.qty;
                    ws.getCell(row, 4).value = dose.notes || '';
                    for (var x = 1; x <= 4; x++) {
                        var dc = ws.getCell(row, x);
                        dc.alignment = { horizontal: x === 4 ? 'right' : 'center', wrapText: true };
                        dc.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                        if (d % 2 === 1) dc.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5F5' } };
                    }
                    row++;
                }
                ws.mergeCells('A' + row + ':B' + row);
                var tlc = ws.getCell('A' + row); tlc.value = '×¡×”×´×› ×× ×•×ª:'; tlc.font = { bold: true };
                tlc.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                tlc.alignment = { horizontal: 'right' };
                tlc.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                var tqc = ws.getCell(row, 3); tqc.value = totalQty; tqc.font = { bold: true };
                tqc.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                tqc.alignment = { horizontal: 'center' };
                tqc.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                var ec = ws.getCell(row, 4);
                ec.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF3CD' } };
                ec.border = { top: { style: 'medium' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
                row += 2;
            }
            wb.xlsx.writeBuffer().then(function(buf) {
                var blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                var lnk = document.createElement('a');
                lnk.href = URL.createObjectURL(blob);
                lnk.download = '×”×–×× ×”_' + (inst || 'order').substring(0, 30) + '_' + (dt || '').replace(/\//g, '-') + '.xlsx';
                document.body.appendChild(lnk); lnk.click(); document.body.removeChild(lnk);
            });
        }
        
        setTomorrowDate();
        document.getElementById('btnAdd').onclick = addToOrder;
        document.getElementById('btnUndo').onclick = undo;
        document.getElementById('btnClear').onclick = clearOrder;
        document.getElementById('btnPrint').onclick = printOrder;
        document.getElementById('btnExport').onclick = exportToExcel;
        document.getElementById('btnEmail').onclick = showEmailModal;
        document.getElementById('btnGmail').onclick = sendViaGmail;
        document.getElementById('btnOutlook').onclick = sendViaOutlook;
        document.getElementById('btnCancel').onclick = hideEmailModal;
        document.getElementById('emailModal').onclick = function(e) { if (e.target.id === 'emailModal') hideEmailModal(); };
    })();
    </script>
</body>
</html>
